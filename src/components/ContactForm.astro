---
const {
  formAction = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT,
  showTitle = true,
  showLabels = true,
  submitText = "Send"
} = Astro.props;
---

<form
  action={formAction}
  method="POST"
  class="grid gap-4 max-w-lg w-full"
  id="contactForm"
>
  {showTitle && <h2 class="text-2xl font-bold mb-2">Contact Me</h2>}

  <label class={showLabels ? "block" : "sr-only"}>
    {showLabels && <span>Name</span>}
    <input type="text" name="name" required class="input input-bordered w-full" placeholder="Your name" />
  </label>

  <label class={showLabels ? "block" : "sr-only"}>
    {showLabels && <span>Email</span>}
    <input type="email" name="email" required class="input input-bordered w-full" placeholder="you@email.com" />
  </label>

  <label class={showLabels ? "block" : "sr-only"}>
    {showLabels && <span>Message</span>}
    <textarea name="message" rows="5" required class="textarea textarea-bordered w-full" placeholder="What can I help you with?" />
  </label>

  <input type="hidden" name="_subject" value="New Portfolio Inquiry" />
  <input type="hidden" name="_redirect" value="https://itsjustivan.com/thank-you" />

  <button type="submit" class="btn btn-primary mt-4">{submitText}</button>

  <p id="formStatus" class="mt-4 text-center text-gray-700"></p>

  <div class="mt-6 pt-4 border-t border-gray-200 text-center">
    <p class="text-gray-600 mb-2">
      Prefer to email directly?
    </p>
    <p class="text-gray-900 text-sm ">
      <a href="mailto:itsjustivanyip@gmail.com" class="hover:underline transition-colors duration-200">itsjustivanyip@gmail.com</a>
    </p>
  </div>
</form>

<script is:inline>
  const form = document.getElementById('contactForm');
  const formStatus = document.getElementById('formStatus'); // Ensure this element exists in the HTML

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    const formData = new FormData(form);
    const formUrl = form.action;

    formStatus.textContent = 'Sending message...';
    formStatus.className = 'mt-4 text-center block text-gray-700';
    form.querySelector('button[type="submit"]').disabled = true;

    try {
      const response = await fetch(formUrl, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        formStatus.textContent = 'Message sent successfully!';
        formStatus.className = 'mt-4 text-center block text-green-600 font-semibold';
        form.reset();

        setTimeout(() => {
          window.location.replace('/thank-you');
        }, 1500);

      } else {
        const data = await response.json();
        if (Object.hasOwnProperty.call(data, 'errors')) {
          formStatus.textContent = data["errors"].map(error => error["message"]).join(", ");
        } else {
          formStatus.textContent = 'Oops! There was a problem sending your message.';
        }
        formStatus.className = 'mt-4 text-center block text-red-600 font-semibold';
        form.querySelector('button[type="submit"]').disabled = false;
      }
    } catch (error) {
      formStatus.textContent = 'Oops! There was a network error.';
      formStatus.className = 'mt-4 text-center block text-red-600 font-semibold';
      form.querySelector('button[type="submit"]').disabled = false;
      console.error('Fetch error:', error);
    }
  });
</script>